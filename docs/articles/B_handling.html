<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Handling FHIR documents with BiocFHIR • BiocFHIR</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Handling FHIR documents with BiocFHIR">
<meta property="og:description" content="BiocFHIR">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">BiocFHIR</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">1.1.4</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../articles/BiocFHIR.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/A_upper.html">Upper level FHIR concepts</a>
    </li>
    <li>
      <a href="../articles/B_handling.html">Handling FHIR documents with BiocFHIR</a>
    </li>
    <li>
      <a href="../articles/C_tables.html">Transforming FHIR documents to tables with BiocFHIR</a>
    </li>
    <li>
      <a href="../articles/D_linking.html">Linking information between FHIR resources</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/vjcitn/BiocFHIR/">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="B_handling_files/htmlwidgets-1.6.2/htmlwidgets.js"></script><link href="B_handling_files/datatables-css-0.0.0/datatables-crosstalk.css" rel="stylesheet">
<script src="B_handling_files/datatables-binding-0.28/datatables.js"></script><link href="B_handling_files/dt-core-1.13.4/css/jquery.dataTables.min.css" rel="stylesheet">
<link href="B_handling_files/dt-core-1.13.4/css/jquery.dataTables.extra.css" rel="stylesheet">
<script src="B_handling_files/dt-core-1.13.4/js/jquery.dataTables.min.js"></script><link href="B_handling_files/crosstalk-1.2.0/css/crosstalk.min.css" rel="stylesheet">
<script src="B_handling_files/crosstalk-1.2.0/js/crosstalk.min.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Handling FHIR documents with BiocFHIR</h1>
                        <h4 data-toc-skip class="author">Vincent J. Carey, stvjc at channing.harvard.edu</h4>
            
            <h4 data-toc-skip class="date">August 24, 2023</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/vjcitn/BiocFHIR/blob/HEAD/vignettes/B_handling.Rmd"><code>vignettes/B_handling.Rmd</code></a></small>
      <div class="hidden name"><code>B_handling.Rmd</code></div>

    </div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>The purpose of this vignette is to provide details on how FHIR documents are handled in BiocFHIR.</p>
<p>This text uses R commands that will work for an R (version 4.2 or greater) in which BiocFHIR (version 0.0.14 or greater) has been installed. The source codes are always available at <a href="https://github.com/vjcitn/BiocFHIR">github</a> and may be available for installation by other means.</p>
<p>We conclude this vignette with a very brief example of the use of consjson to interrogate the FHIR JSON documents directly.</p>
</div>
<div class="section level2">
<h2 id="examining-sample-data-again">Examining sample data, again<a class="anchor" aria-label="anchor" href="#examining-sample-data-again"></a>
</h2>
<p>In the “Upper level FHIR concepts” vignette, we used the following code to get a peek at the information structure in a single document representing a Bundle associated with a patient.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">tfile</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.files.html" class="external-link">dir</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"json"</span>, package<span class="op">=</span><span class="st">"BiocFHIR"</span><span class="op">)</span>, full<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">peek</span> <span class="op">=</span> <span class="fu">jsonlite</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/jsonlite/man/fromJSON.html" class="external-link">fromJSON</a></span><span class="op">(</span><span class="va">tfile</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">peek</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] "resourceType" "type"         "entry"</span></span></code></pre>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">peek</span><span class="op">$</span><span class="va">resourceType</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] "Bundle"</span></span></code></pre>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">peek</span><span class="op">$</span><span class="va">entry</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] "fullUrl"  "resource" "request"</span></span></code></pre>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">peek</span><span class="op">$</span><span class="va">entry</span><span class="op">$</span><span class="va">resource</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 72</span></span></code></pre>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">class</a></span><span class="op">(</span><span class="va">peek</span><span class="op">$</span><span class="va">entry</span><span class="op">$</span><span class="va">resource</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] "data.frame"</span></span></code></pre>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">peek</span><span class="op">$</span><span class="va">entry</span><span class="op">$</span><span class="va">resource</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 301  72</span></span></code></pre>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">peek</span><span class="op">$</span><span class="va">entry</span><span class="op">$</span><span class="va">resource</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] "resourceType" "id"           "text"         "extension"    "identifier"  </span></span>
<span><span class="co">## [6] "name"</span></span></code></pre>
</div>
<div class="section level2">
<h2 id="choosing-an-approach-to-fhir-json-ingestion">Choosing an approach to FHIR JSON ingestion<a class="anchor" aria-label="anchor" href="#choosing-an-approach-to-fhir-json-ingestion"></a>
</h2>
<p>Some of the complexity of working with FHIR JSON in R in this way can be seen in the following:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">vapply</a></span><span class="op">(</span><span class="va">peek</span><span class="op">$</span><span class="va">entry</span><span class="op">$</span><span class="va">resource</span><span class="op">$</span><span class="va">category</span>, </span>
<span>   <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/logical.html" class="external-link">logical</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1]  6 10 11 12 13 14</span></span></code></pre>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">peek</span><span class="op">$</span><span class="va">entry</span><span class="op">$</span><span class="va">resource</span><span class="op">$</span><span class="va">category</span><span class="op">[[</span><span class="fl">6</span><span class="op">]</span><span class="op">]</span></span></code></pre></div>
<pre><code><span><span class="co">##         coding      text</span></span>
<span><span class="co">## 1 http://s.... Self care</span></span></code></pre>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">peek</span><span class="op">$</span><span class="va">entry</span><span class="op">$</span><span class="va">resource</span><span class="op">$</span><span class="va">category</span><span class="op">[[</span><span class="fl">6</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">coding</span></span></code></pre></div>
<pre><code><span><span class="co">## [[1]]</span></span>
<span><span class="co">##                   system            code   display</span></span>
<span><span class="co">## 1 http://snomed.info/sct 326051000000105 Self care</span></span></code></pre>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">peek</span><span class="op">$</span><span class="va">entry</span><span class="op">$</span><span class="va">resource</span><span class="op">$</span><span class="va">category</span><span class="op">[[</span><span class="fl">10</span><span class="op">]</span><span class="op">]</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] "food"</span></span></code></pre>
<p>Elements of category can be data.frame or atomic. This is a consequence of naive use of <code><a href="https://rdrr.io/pkg/jsonlite/man/fromJSON.html" class="external-link">jsonlite::fromJSON</a></code>.</p>
<p>When we reduce the transformations attempted by <code>fromJSON</code>, empty fields are not propagated.</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">peek2</span> <span class="op">=</span> <span class="fu">jsonlite</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/jsonlite/man/fromJSON.html" class="external-link">fromJSON</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.files.html" class="external-link">dir</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"json"</span>, package<span class="op">=</span><span class="st">"BiocFHIR"</span><span class="op">)</span>, full<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span>, simplifyVector<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">peek2</span><span class="op">$</span><span class="va">entry</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">]</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">x</span><span class="op">[[</span><span class="st">"resource"</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [[1]]</span></span>
<span><span class="co">##  [1] "resourceType"         "id"                   "text"                </span></span>
<span><span class="co">##  [4] "extension"            "identifier"           "name"                </span></span>
<span><span class="co">##  [7] "telecom"              "gender"               "birthDate"           </span></span>
<span><span class="co">## [10] "deceasedDateTime"     "address"              "maritalStatus"       </span></span>
<span><span class="co">## [13] "multipleBirthBoolean" "communication"       </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## [[2]]</span></span>
<span><span class="co">## [1] "resourceType" "id"           "identifier"   "active"       "type"        </span></span>
<span><span class="co">## [6] "name"         "telecom"      "address"     </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## [[3]]</span></span>
<span><span class="co">## [1] "resourceType" "id"           "identifier"   "active"       "name"        </span></span>
<span><span class="co">## [6] "telecom"      "address"      "gender"      </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## [[4]]</span></span>
<span><span class="co">## [1] "resourceType"    "id"              "status"          "class"          </span></span>
<span><span class="co">## [5] "type"            "subject"         "participant"     "period"         </span></span>
<span><span class="co">## [9] "serviceProvider"</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## [[5]]</span></span>
<span><span class="co">## [1] "resourceType"         "id"                   "status"              </span></span>
<span><span class="co">## [4] "subject"              "encounter"            "period"              </span></span>
<span><span class="co">## [7] "participant"          "managingOrganization"</span></span></code></pre>
<p>Because the JSON ingestion does not attempt to simplify table-like content, we have a list of lists with varying depths of nesting.</p>
<p>We can tabulate the resource types using</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rtyvec</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">vapply</a></span><span class="op">(</span><span class="va">peek2</span><span class="op">$</span><span class="va">entry</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> </span>
<span>   <span class="va">x</span><span class="op">[[</span><span class="st">"resource"</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">resourceType</span>, <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">character</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/table.html" class="external-link">table</a></span><span class="op">(</span><span class="va">rtyvec</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## rtyvec</span></span>
<span><span class="co">##   AllergyIntolerance             CarePlan             CareTeam </span></span>
<span><span class="co">##                    8                    3                    3 </span></span>
<span><span class="co">##                Claim            Condition     DiagnosticReport </span></span>
<span><span class="co">##                   46                   15                    3 </span></span>
<span><span class="co">##            Encounter ExplanationOfBenefit         Immunization </span></span>
<span><span class="co">##                   37                   37                   10 </span></span>
<span><span class="co">##    MedicationRequest          Observation         Organization </span></span>
<span><span class="co">##                    9                  114                    3 </span></span>
<span><span class="co">##              Patient         Practitioner            Procedure </span></span>
<span><span class="co">##                    1                    3                    9</span></span></code></pre>
</div>
<div class="section level2">
<h2 id="working-with-a-specific-type">Working with a specific type<a class="anchor" aria-label="anchor" href="#working-with-a-specific-type"></a>
</h2>
<div class="section level3">
<h3 id="list-based-operations">List-based operations<a class="anchor" aria-label="anchor" href="#list-based-operations"></a>
</h3>
<p>Let’s use <code>peek2</code> to extract Conditions recorded on the patient.</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">iscond</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">rtyvec</span> <span class="op">==</span> <span class="st">"Condition"</span><span class="op">)</span></span>
<span><span class="va">conds</span> <span class="op">=</span> <span class="va">peek2</span><span class="op">$</span><span class="va">entry</span><span class="op">[</span><span class="va">iscond</span><span class="op">]</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">conds</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 15</span></span></code></pre>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="va">conds</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## List of 3</span></span>
<span><span class="co">##  $ fullUrl : chr "urn:uuid:adc05f8e-0e90-4217-b1d7-fa41b8e33638"</span></span>
<span><span class="co">##  $ resource:List of 9</span></span>
<span><span class="co">##   ..$ resourceType      : chr "Condition"</span></span>
<span><span class="co">##   ..$ id                : chr "adc05f8e-0e90-4217-b1d7-fa41b8e33638"</span></span>
<span><span class="co">##   ..$ clinicalStatus    :List of 1</span></span>
<span><span class="co">##   .. ..$ coding:List of 1</span></span>
<span><span class="co">##   .. .. ..$ :List of 2</span></span>
<span><span class="co">##   .. .. .. ..$ system: chr "http://terminology.hl7.org/CodeSystem/condition-clinical"</span></span>
<span><span class="co">##   .. .. .. ..$ code  : chr "active"</span></span>
<span><span class="co">##   ..$ verificationStatus:List of 1</span></span>
<span><span class="co">##   .. ..$ coding:List of 1</span></span>
<span><span class="co">##   .. .. ..$ :List of 2</span></span>
<span><span class="co">##   .. .. .. ..$ system: chr "http://terminology.hl7.org/CodeSystem/condition-ver-status"</span></span>
<span><span class="co">##   .. .. .. ..$ code  : chr "confirmed"</span></span>
<span><span class="co">##   ..$ code              :List of 2</span></span>
<span><span class="co">##   .. ..$ coding:List of 1</span></span>
<span><span class="co">##   .. .. ..$ :List of 3</span></span>
<span><span class="co">##   .. .. .. ..$ system : chr "http://snomed.info/sct"</span></span>
<span><span class="co">##   .. .. .. ..$ code   : chr "446096008"</span></span>
<span><span class="co">##   .. .. .. ..$ display: chr "Perennial allergic rhinitis"</span></span>
<span><span class="co">##   .. ..$ text  : chr "Perennial allergic rhinitis"</span></span>
<span><span class="co">##   ..$ subject           :List of 1</span></span>
<span><span class="co">##   .. ..$ reference: chr "urn:uuid:eedf9986-9cf8-4e90-bf68-12a6dd9a31c2"</span></span>
<span><span class="co">##   ..$ encounter         :List of 1</span></span>
<span><span class="co">##   .. ..$ reference: chr "urn:uuid:9c95930d-83a4-4a89-9bbb-8e540e729233"</span></span>
<span><span class="co">##   ..$ onsetDateTime     : chr "1973-06-29T07:25:09-04:00"</span></span>
<span><span class="co">##   ..$ recordedDate      : chr "1973-06-29T07:25:09-04:00"</span></span>
<span><span class="co">##  $ request :List of 2</span></span>
<span><span class="co">##   ..$ method: chr "POST"</span></span>
<span><span class="co">##   ..$ url   : chr "Condition"</span></span></code></pre>
<p>Digging out the data and metadata on the first condition recorded (Perennial allergic rhinitis), is somewhat complex using R. Direct operations on JSON with JMESPATH might be more effective, but we postpone this investigation.</p>
</div>
<div class="section level3">
<h3 id="processing-with-biocfhir">Processing with BiocFHIR<a class="anchor" aria-label="anchor" href="#processing-with-biocfhir"></a>
</h3>
<p>In the <code>process_fhir_bundle</code> function of BiocFHIR we allow <code><a href="https://rdrr.io/pkg/jsonlite/man/fromJSON.html" class="external-link">jsonlite::fromJSON</a></code> to conduct some simplification of list structures amenable to representation as tables (data.frames).</p>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">tbu</span> <span class="op">=</span> <span class="fu"><a href="../reference/process_fhir_bundle.html">process_fhir_bundle</a></span><span class="op">(</span><span class="va">tfile</span><span class="op">)</span></span>
<span><span class="va">tbu</span></span></code></pre></div>
<pre><code><span><span class="co">## BiocFHIR FHIR.bundle instance.</span></span>
<span><span class="co">##   resource types are:</span></span>
<span><span class="co">##    AllergyIntolerance CarePlan ... Patient Procedure</span></span></code></pre>
<p>For the reports of Conditions, we extract specific fields that are commonly used in the Synthea examples. Other bundle sets may use different fields.</p>
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ctab</span> <span class="op">=</span> <span class="fu"><a href="../reference/process_Condition.html">process_Condition</a></span><span class="op">(</span><span class="va">tbu</span><span class="op">$</span><span class="va">Condition</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">ctab</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 15  5</span></span></code></pre>
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">datatable</span><span class="op">(</span><span class="va">ctab</span><span class="op">)</span></span></code></pre></div>
<div class="datatables html-widget html-fill-item-overflow-hidden html-fill-item" id="htmlwidget-6de3c4f78cfcdc094db2" style="width:100%;height:auto;"></div>
<script type="application/json" data-for="htmlwidget-6de3c4f78cfcdc094db2">{"x":{"filter":"none","vertical":false,"data":[["1","2","3","4","5","6","7","8","9","10","11","12","13","14","15"],["adc05f8e-0e90-4217-b1d7-fa41b8e33638","a7c0f1bf-f590-4264-9d23-7d572814097b","793a03ca-7c3e-4410-99ca-b8b88651610b","bdd14588-4969-45b2-9170-e4ae6ef9f8ca","d3c797f5-b972-4047-b829-1ec32084e1e1","91b48a2b-d649-4ee9-8dc8-170956480df6","66e90602-4775-45cd-b7f0-4d7655658020","ed286f51-d8b8-4cdd-bfd3-3a49b96026ec","118eecc5-8594-4c88-a5d1-eae9d6975b7a","98d3e627-4e0c-414b-8b33-070d6c13b17d","a26ddcf6-c4dd-47a9-b3c1-5a4fc48f83a7","db492aea-c5ce-4421-bdab-0c4172f5f341","1c027d75-8838-47bf-98ea-36e05478d6bf","b7a2b401-4e75-461a-a5ce-24737861c145","a7e1e1ba-240c-46ce-aa4f-83e3ee7f9cd2"],["urn:uuid:eedf9986-9cf8-4e90-bf68-12a6dd9a31c2","urn:uuid:eedf9986-9cf8-4e90-bf68-12a6dd9a31c2","urn:uuid:eedf9986-9cf8-4e90-bf68-12a6dd9a31c2","urn:uuid:eedf9986-9cf8-4e90-bf68-12a6dd9a31c2","urn:uuid:eedf9986-9cf8-4e90-bf68-12a6dd9a31c2","urn:uuid:eedf9986-9cf8-4e90-bf68-12a6dd9a31c2","urn:uuid:eedf9986-9cf8-4e90-bf68-12a6dd9a31c2","urn:uuid:eedf9986-9cf8-4e90-bf68-12a6dd9a31c2","urn:uuid:eedf9986-9cf8-4e90-bf68-12a6dd9a31c2","urn:uuid:eedf9986-9cf8-4e90-bf68-12a6dd9a31c2","urn:uuid:eedf9986-9cf8-4e90-bf68-12a6dd9a31c2","urn:uuid:eedf9986-9cf8-4e90-bf68-12a6dd9a31c2","urn:uuid:eedf9986-9cf8-4e90-bf68-12a6dd9a31c2","urn:uuid:eedf9986-9cf8-4e90-bf68-12a6dd9a31c2","urn:uuid:eedf9986-9cf8-4e90-bf68-12a6dd9a31c2"],["http://snomed.info/sct","http://snomed.info/sct","http://snomed.info/sct","http://snomed.info/sct","http://snomed.info/sct","http://snomed.info/sct","http://snomed.info/sct","http://snomed.info/sct","http://snomed.info/sct","http://snomed.info/sct","http://snomed.info/sct","http://snomed.info/sct","http://snomed.info/sct","http://snomed.info/sct","http://snomed.info/sct"],["446096008","65363002","75498004","40055000","241929008","36971009","44465007","444814009","444814009","44465007","241929008","444814009","128613002","703151001","84757009"],["Perennial allergic rhinitis","Otitis media","Acute bacterial sinusitis (disorder)","Chronic sinusitis (disorder)","Acute allergic reaction","Sinusitis (disorder)","Sprain of ankle","Viral sinusitis (disorder)","Viral sinusitis (disorder)","Sprain of ankle","Acute allergic reaction","Viral sinusitis (disorder)","Seizure disorder","History of single seizure (situation)","Epilepsy"]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>id<\/th>\n      <th>subject.reference<\/th>\n      <th>code.coding.system<\/th>\n      <th>code.coding.code<\/th>\n      <th>code.coding.display<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false},"selection":{"mode":"multiple","selected":null,"target":"row","selectable":null}},"evals":[],"jsHooks":[]}</script><p>The fields collected in <code>process_Condition</code> are specified in <code><a href="../reference/FHIR_retention_schemas.html">FHIR_retention_schemas()</a></code>. Eventually this will need to become a user-specified element of ingestion and transformation.</p>
</div>
</div>
<div class="section level2">
<h2 id="direct-querying-of-fhir-json">Direct querying of FHIR JSON<a class="anchor" aria-label="anchor" href="#direct-querying-of-fhir-json"></a>
</h2>
<p>We’ve shown how we can operate on FHIR documents from the Synthea project using specific schemas to select elements from lists produced by parsing JSON. The FHIR specification is very flexible, and the <code>process_*</code> methods defined here may not work for FHIR documents from other sources.</p>
<p>The jsoncons library provides C++ code for parsing and filtering JSON, and the <a href="https://CRAN.R-project.org/package=rjsoncons" class="external-link">rjsoncons</a> package is available to support JMESPATH queries.</p>
<p>In this example, we’ll take 4 Synthea FHIR documents and extract patient addresses to a data.frame.</p>
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">z</span> <span class="op">=</span> <span class="fu"><a href="../reference/make_test_json_set.html">make_test_json_set</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">myl</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">z</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">4</span><span class="op">]</span>, <span class="fu">jsonlite</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/jsonlite/man/fromJSON.html" class="external-link">fromJSON</a></span><span class="op">)</span> <span class="co"># list that rconsjson will convert to JSON</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">rjsoncons</span><span class="op">)</span></span>
<span><span class="va">tmp</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/rjsoncons/man/jsoncons.html" class="external-link">jmespath</a></span><span class="op">(</span><span class="va">myl</span>, <span class="st">"[*].entry[0].resource.address"</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu">jsonlite</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/jsonlite/man/fromJSON.html" class="external-link">fromJSON</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="va">rbind</span>,<span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">tmp</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">x</span><span class="op">[</span>,<span class="op">-</span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">)</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##          city         state postalCode country</span></span>
<span><span class="co">## 1      Malden Massachusetts      02148      US</span></span>
<span><span class="co">## 2 Springfield Massachusetts      01013      US</span></span>
<span><span class="co">## 3    Brewster Massachusetts      02631      US</span></span>
<span><span class="co">## 4     Webster Massachusetts      01570      US</span></span></code></pre>
<p>The JMESPATH query projects from all documents via the initial <code>[*]</code>. It then retrieves the address element from the resource element of the first ([0]) entry. An overview of the hierarchical structure of <code>myl</code> can be obtained using <code><a href="https://rdrr.io/pkg/listviewer/man/jsonedit.html" class="external-link">listviewer::jsonedit</a></code>.</p>
</div>
<div class="section level2">
<h2 id="session-information">Session information<a class="anchor" aria-label="anchor" href="#session-information"></a>
</h2>
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/sessionInfo.html" class="external-link">sessionInfo</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## R version 4.3.1 Patched (2023-07-22 r84743)</span></span>
<span><span class="co">## Platform: x86_64-pc-linux-gnu (64-bit)</span></span>
<span><span class="co">## Running under: Ubuntu 20.04.6 LTS</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Matrix products: default</span></span>
<span><span class="co">## BLAS:   /home/stvjc/R-430-dist/lib/R/lib/libRblas.so </span></span>
<span><span class="co">## LAPACK: /home/stvjc/R-430-dist/lib/R/lib/libRlapack.so;  LAPACK version 3.11.0</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## locale:</span></span>
<span><span class="co">##  [1] LC_CTYPE=en_US.UTF-8       LC_NUMERIC=C              </span></span>
<span><span class="co">##  [3] LC_TIME=en_US.UTF-8        LC_COLLATE=en_US.UTF-8    </span></span>
<span><span class="co">##  [5] LC_MONETARY=en_US.UTF-8    LC_MESSAGES=en_US.UTF-8   </span></span>
<span><span class="co">##  [7] LC_PAPER=en_US.UTF-8       LC_NAME=C                 </span></span>
<span><span class="co">##  [9] LC_ADDRESS=C               LC_TELEPHONE=C            </span></span>
<span><span class="co">## [11] LC_MEASUREMENT=en_US.UTF-8 LC_IDENTIFICATION=C       </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## time zone: America/New_York</span></span>
<span><span class="co">## tzcode source: system (glibc)</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## attached base packages:</span></span>
<span><span class="co">## [1] stats     graphics  grDevices utils     datasets  methods   base     </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## other attached packages:</span></span>
<span><span class="co">## [1] rjsoncons_1.0.0  jsonlite_1.8.7   DT_0.28          BiocFHIR_1.1.4  </span></span>
<span><span class="co">## [5] BiocStyle_2.28.0</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## loaded via a namespace (and not attached):</span></span>
<span><span class="co">##  [1] tidyr_1.3.0         sass_0.4.7          utf8_1.2.3         </span></span>
<span><span class="co">##  [4] generics_0.1.3      stringi_1.7.12      digest_0.6.33      </span></span>
<span><span class="co">##  [7] magrittr_2.0.3      evaluate_0.21       bookdown_0.35      </span></span>
<span><span class="co">## [10] fastmap_1.1.1       rprojroot_2.0.3     graph_1.78.0       </span></span>
<span><span class="co">## [13] promises_1.2.1      BiocManager_1.30.22 purrr_1.0.2        </span></span>
<span><span class="co">## [16] fansi_1.0.4         crosstalk_1.2.0     textshaping_0.3.6  </span></span>
<span><span class="co">## [19] jquerylib_0.1.4     cli_3.6.1           shiny_1.7.5        </span></span>
<span><span class="co">## [22] rlang_1.1.1         visNetwork_2.1.2    ellipsis_0.3.2     </span></span>
<span><span class="co">## [25] cachem_1.0.8        yaml_2.3.7          BiocBaseUtils_1.2.0</span></span>
<span><span class="co">## [28] tools_4.3.1         memoise_2.0.1       dplyr_1.1.2        </span></span>
<span><span class="co">## [31] httpuv_1.6.11       BiocGenerics_0.46.0 vctrs_0.6.3        </span></span>
<span><span class="co">## [34] R6_2.5.1            mime_0.12           stats4_4.3.1       </span></span>
<span><span class="co">## [37] lifecycle_1.0.3     stringr_1.5.0       htmlwidgets_1.6.2  </span></span>
<span><span class="co">## [40] fs_1.6.3            ragg_1.2.5          pkgconfig_2.0.3    </span></span>
<span><span class="co">## [43] desc_1.4.2          pkgdown_2.0.7       pillar_1.9.0       </span></span>
<span><span class="co">## [46] bslib_0.5.1         later_1.3.1         glue_1.6.2         </span></span>
<span><span class="co">## [49] Rcpp_1.0.11         systemfonts_1.0.4   xfun_0.40          </span></span>
<span><span class="co">## [52] tibble_3.2.1        tidyselect_1.2.0    knitr_1.43         </span></span>
<span><span class="co">## [55] xtable_1.8-4        htmltools_0.5.6     rmarkdown_2.24     </span></span>
<span><span class="co">## [58] compiler_4.3.1</span></span></code></pre>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Vincent Carey.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
